#
# Minimal Migration Manager
# Copyright (C) 2015 Tim Hentenaar.
#
# This code is licenced under the Simplified BSD License.
# See the LICENSE file for details.
#
CC=@CC@
GCOVR=@GCOVR@

CPPFLAGS=-DIN_TESTS @DEFS@ @CPPFLAGS@
LDFLAGS=@LDFLAGS@
LIBS=-lcheck
CFLAGS=-g @CFLAGS@
HAVE_CHECK=@have_check@

# Gather the test sources
SRCS := $(wildcard *.c)

# Default flags for gcovr
GCOVR_FLAGS = -d -r .. -e '^test/'

# If COVERAGE is defined, generate a coverage report.
ifneq ($(origin COVERAGE), undefined)
ifneq (,$(GCOVR))
  CFLAGS := -O0 -coverage $(filter-out -O2,$(CFLAGS))

# Don't remove gcov files when using coveralls
ifneq ($(origin COVERALLS), undefined)
  GCOVR_FLAGS := $(filter-out -d,$(GCOVR_FLAGS))
endif # COVERALLS
endif # GCOVR
endif # COVERAGE

#
# Targets
#

all: check

clean:
	@$(RM) test_runner

ifeq (no, $(HAVE_CHECK))
check: ;$(warning check must be installed to build the tests.)
else
check: test_runner
	@./test_runner

test_runner: $(SRCS)
	@echo "  LD $@"
	@$(CC) $(CPPFLAGS) $(CFLAGS) -o $@ $^ ${LIBS}

ifeq (,$(GCOVR))
coverage: ;$(warning gcovr must be installed for coverage reports.)
else
coverage: check
	@echo
	@$(GCOVR) $(GCOVR_FLAGS)
ifneq ($(origin COVERALLS), undefined)
	@coveralls -r .. --gcov-options '\-lp'
endif
	@$(RM) -f *.gc[nd][oa]
endif # GCOVR
endif # HAVE_CHECK

.PHONY: all clean check coverage
